<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Solar Report</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<script src="../wp-content/themes/enfold-child/js/nouislider.min.js"></script>
	<script src="../wp-content/themes/enfold-child/js/SolarAutarki.js"></script>
	<!-- <script type="text/JavaScript" src="../wp-content/themes/enfold-child/js/jsDraw2D.js"></script> -->
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<link href="../wp-content/themes/enfold-child/css/nouislider.min.css" rel="stylesheet">
	<!-- Charts JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
<style>
#batterystatuschart {
background-image: url("batterystatus.png");
}
.behaelter {
margin-left: 0px;
}
.schieber{
	margin: 16px;
	display: inline-block;
	height: 150px;
}
.sliders{
	margin: 8px;
	display: inline-block;
	height: 150px;
	width: 10px;
}
.noUi-tooltip {
    display: none;
}
.noUi-active .noUi-tooltip {
    display: block;
}
#autarkitable {
	text-align: center;
    border-collapse: collapse;
    width: 100%;
	font-family:    Tahoma;
}

#체berschrift {
	border: 1px solid #ddd;
}
#autarkitable td {
	font-size: 12px;
    border-bottom: 1px solid #ddd;
    padding: 8px;
}

#autarkitable th:hover {background-color: #E7EFF7;}
#autarkitable td:hover {background-color: #E7EFF7;}

#autarkitable th {
	width: 200px;
	font-weight: 900;
	font-size: 12px;
	padding: 8px;
    padding-top: 12px;
    padding-bottom: 12px;
    background-color: #E6E6E6;
    color: #505050;
	border: 1px solid #ddd;
}
</style>
</head>
<body onload="refreshhorizon()" onchange="refreshwhperday()">
<div class="container">
	<div class="card">
		<h4 class="card-header">Solar Reporter</h4>
	<form action="#" >
	<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseLocation" aria-expanded="false" aria-controls="collapseLocation">
	Location
  </button>
  <div class="collapse" id="collapseLocation">
  <div class="card card-body">
  <div class="input-group mb-3">
    <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon3">Lat</span>
  </div>
  <input id='latitude' value="48.19" type="number" class="form-control" aria-label="latitude" aria-describedby="basic-addon3">
    <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon4">Long</span>
  </div>
  <input id='longitude' value="16" type="number" class="form-control" aria-label="longitude" aria-describedby="basic-addon4">
    <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon1">Anfang</span>
  </div>
  <input id='anfang' type="text" class="form-control" aria-label="anfang" aria-describedby="basic-addon1">
    <div class="input-group-prepend">
    <span class="input-group-text" id="basic-addon2">Ende</span>
  </div>
  <input id='ende' type="text" class="form-control" aria-label="ende" aria-describedby="basic-addon2">
    <div class="input-group-prepend">
    <div class="input-group-text">
	<input type="radio" name='timeframe' onClick="setwowinter()"> ohne Winter
    </div>
	    <div class="input-group-text">
	<input type="radio" name='timeframe' onClick="setyear()"> ganzes Jahr
    </div>
  </div>
</div>
	<div id="html5Slider"></div><br>
		  </div>
</div>
	  <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseHorizon" aria-expanded="false" aria-controls="collapseHorizon">
	Erstelle horizontal file
  </button>
<div class="collapse" id="collapseHorizon">
  <div class="card card-body">
	<select id="horizontauswahl" onload="refreshhorizon()" onchange="refreshhorizon()">
	  <option value="0">Ebene</option>
	  <option value="1">Aspangstrasse</option>
	  </select><br><br>
	<div class="behaelter">
	<b id='25'>0 </b><div class="schieber" id="100"></div>
	<b id='26'>0 </b><div class="schieber" id="101"></div>
	<b id='27'>0 </b><div class="schieber" id="102"></div>
	<b id='28'>0 </b><div class="schieber" id="103"></div>
	<b id='29'>0 </b><div class="schieber" id="104"></div>
	<b id='30'>0 </b><div class="schieber" id="105"></div>
	<b id='31'>0 </b><div class="schieber" id="106"></div>
	<b id='32'>0 </b><div class="schieber" id="107"></div>
	<b id='33'>0 </b><div class="schieber" id="108"></div>
	<b id='34'>0 </b><div class="schieber" id="109"></div>
	<b id='35'>0 </b><div class="schieber" id="110"></div>
	<b id='36'>0 </b><div class="schieber" id="111"></div>
	<b id='37'>0 </b><div class="schieber" id="112"></div>
	</div>
	  </div>
</div>
<div class="card">
  <div  class="card-body">
  <div id='applist' class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text">Verbraucher</span>
  </div>
  <input id="verbraucher" type="number" class="form-control" value='0'>
  <div class="input-group-append">
    <span class="input-group-text">W</span>
  </div>
    <div class="input-group-prepend">
    <span class="input-group-text">Leistung insgesammt</span>
  </div>
  <input id="verbrauchtotal" type="number" class="form-control" value='0'>
  <div class="input-group-append">
    <span class="input-group-text">W</span>
  </div>
    <div class="input-group-prepend">
    <span class="input-group-text">Wattstunden am Tag</span>
  </div>
  <input id="whperday" type="text" class="form-control" value='configure the profil'>
  <div class="input-group-append">
    <span class="input-group-text">Wh/d</span>
  </div>
</div>
<div id='appprofiler'>
<select id="profilauswahl" onchange="refreshprofil()">
	<option value="" selected disabled hidden>Erstelle app-profil</option>
	  <option value="0">light</option>
	  <option value="1">smartphone</option>
	  <option value="2">E-bike</option>
	  <option value="3">workmusic</option>
	  <option value="4">nightmusic</option>
	  <option value="5">fridge</option>
	  <option value="6">wasserpumpe</option>
	  <option value="7">multimediaecke</option>
	  <option value="8">coffee</option>
	  <option value="9">s채ge</option>
	  <option value="10">k체chenmaschine</option>
	  <option value="11">ventilator</option>
	</select> <button class="btn btn-outline-secondary" type="button" onClick='addapp()'>App hinzuf체gen</button><br><br>
	<div class="behaelter">
	1<div class="sliders" id="0"></div>
	2<div class="sliders" id="1"></div>
	3<div class="sliders" id="2"></div>
	4<div class="sliders" id="3"></div>
	5<div class="sliders" id="4"></div>
	6<div class="sliders" id="5"></div>
	7<div class="sliders" id="6"></div>
	8<div class="sliders" id="7"></div>
	9<div class="sliders" id="8"></div>
	10<div class="sliders" id="9"></div>
	11<div class="sliders" id="10"></div>
	12<div class="sliders" id="11"></div>
	13<div class="sliders" id="12"></div>
	14<div class="sliders" id="13"></div>
	15<div class="sliders" id="14"></div>
	16<div class="sliders" id="15"></div>
	17<div class="sliders" id="16"></div>
	18<div class="sliders" id="17"></div>
	19<div class="sliders" id="18"></div>
	20<div class="sliders" id="19"></div>
	21<div class="sliders" id="20"></div>
	22<div class="sliders" id="21"></div>
	23<div class="sliders" id="22"></div>
	24<div class="sliders" id="23"></div>
	</div>
</div>	
</div>	
</div>
</form>
	<button class="btn btn-primary" type="button" data-target="#collapsecards" aria-expanded="false" aria-controls="collapsecards" onClick="anfangarsch()">
	which SolCube?
  </button>
<div class="collapse" id="collapsecards">
<div class="card-group">
  <div class="card">
    <img class="card-img-top" src="../wp-content/themes/enfold-child/img/moduleSmall.png" alt="Card image cap">
    <div class="card-body">
      <h5 class="card-title">SolCube basic</h5>
	  <ul id="basiclist" class="list-group"></ul>
      <p id="2weak" class="card-text"></p>
	  <button id ='basic' type="button" class="btn btn-primary" onClick="refresh(this.id)">show in chart</button>
    </div>
  </div>
  <div class="card">
    <img class="card-img-top" src="../wp-content/themes/enfold-child/img/moduleMedium.png" alt="Card image cap">
    <div class="card-body">
      <h5 class="card-title">SolCube Pro</h5>
	  <ul id="prolist" class="list-group"></ul>
      <p id="good" class="card-text"></p>
	  <button id ='pro' type="button" class="btn btn-primary" onClick="refresh(this.id)">show in chart</button>
    </div>
  </div>
  <div class="card">
    <img class="card-img-top" src="../wp-content/themes/enfold-child/img/module2xMedium.png" alt="Card image cap">
    <div class="card-body">
      <h5 class="card-title">SolCube Ultimate</h5>
	  <ul id="ultimatelist" class="list-group"></ul>
      <p id="outstanding" class="card-text"></p>
	  <button id ='ultimate' type="button" class="btn btn-primary" onClick="refresh(this.id)">show in chart</button>
    </div>
  </div>
</div>	
</div>	
<div class="card">
  <div class="card-body">
  <div class="input-group mb-3">
  <div class="input-group-prepend">
    <span class="input-group-text">batterysize</span>
  </div>
  <input id="batterysize" type="number" class="form-control" value='216'>
  <div class="input-group-append">
    <span class="input-group-text">Wh</span>
  </div>
  <div class="input-group-prepend">
    <span class="input-group-text">rated Power</span>
  </div>
  <input id="ratedpower" type="number" class="form-control" value='150'>
  <div class="input-group-append">
    <span class="input-group-text">Wp</span>
  </div>
  <div class="input-group-prepend">
    <span class="input-group-text">Tilt</span>
  </div>
  <input id="tilt" type="number" min="0" max="90" step="5" class="form-control" value='90' onload="refresh(this.id)" onchange="refresh(this.id)">
    <div class="input-group-prepend">
    <span class="input-group-text">ModuleAzi</span>
  </div>
  <select id="moduleazi" class="custom-select" onload="refreshhorizon()" onchange="refreshhorizon()" >
	<option value="0">Norden</option>
	  <option value="15">15</option>
	  <option value="30">30</option>
	  <option value="45">Nord-Ost</option>
	  <option value="60">60</option>
	  <option value="75">75</option>
	  <option value="90">Osten</option>
	  <option value="105">105</option>
	  <option value="120">120</option>
	  <option value="135">S체d-Ost</option>
	  <option value="150">150</option>
	  <option value="165">165</option>
	  <option value="180">S체den</option>
	  <option value="195">195</option>
	  <option value="210" selected="selected">210</option>
	  <option value="225">S체d-West</option>
	  <option value="240">240</option>
	  <option value="255">255</option>
	  <option value="270">West</option>
	  <option value="285">285</option>
	  <option value="300">300</option>
	  <option value="315">Nord-West</option>
	  <option value="330">330</option>
	  <option value="345">345</option>
	</select>
	</div>	
	</div>
		<canvas id="batterystatuschart" style="width:800px;height:600px;"></canvas>
		<canvas id="yearlysolar" style="width:800px;height:440px;"></canvas>
		<canvas id="horizon" style="width:800px;height:440px;"></canvas>
	</div>
</div>
<script>
//globals needed for UI and charts
var startingday = document.getElementById('anfang');
var endday = document.getElementById('ende');
var myChart1;
var myChart2;
var myChart3;
var number=1;
function refresh(paras){
var latitude = document.getElementById('latitude').value;
var longitude = document.getElementById('longitude').value;
var ratedpower = document.getElementById('ratedpower');
var batterysize = document.getElementById('batterysize');
switch(paras){
case "basic":
var batsize = 'basicbat';
var modsize = 'basicmod';
var chartbat = (document.getElementById(batsize).innerText*1);
var chartmod = (document.getElementById(modsize).innerText*1);
break;
case "pro":
var batsize = 'probat';
var modsize = 'promod';
var chartbat = (document.getElementById(batsize).innerText*1);
var chartmod = (document.getElementById(modsize).innerText*1);
break;
case "ultimate":
var batsize = 'ultibat';
var modsize = 'ultimod';
var chartbat = (document.getElementById(batsize).innerText*1);
var chartmod = (document.getElementById(modsize).innerText*1);
break;
default:
var chartbat = (document.getElementById('batterysize').value*1);
var chartmod = (document.getElementById('ratedpower').value*1);
}
ratedpower.value = chartmod;
batterysize.value = chartbat;
refresher(latitude,longitude);
}
// extra function to refresh the charts seperatly. should be combined with function anfangarsch() in a object
function refresher(lat, lng)
{
    var request = {
				lat: lat,
				lng: lng
	};
    var json = JSON.stringify(request);
    $.ajax({
      type: "POST",
      dataType: "JSON",
      url: "https://base.energy/webservice/getGhi.php", //Relative or absolute path to response.php file
      data: json,
      success: function(realskyaverage) {

		showbatterystatus(realskyaverage);
		showsolaryearly(realskyaverage);
		showhorizont(realskyaverage);
}})
}

function setyear(){
html5Slider.noUiSlider.set([1, 365]);
}

function setwowinter(){
html5Slider.noUiSlider.set([81, 264]);
}

var html5Slider = document.getElementById('html5Slider');

noUiSlider.create(html5Slider, {
    start: [81, 264],
    connect: true,
	tooltips: [ false, false ],
	step: 1,
    range: {
        'min': 1,
        'max': 365
    }
});

html5Slider.noUiSlider.on('update', function( values, handle ) {

	var value = values[handle];

	if ( handle ) {
		endday.value = value*1;
	} else {
		startingday.value = value*1;
	}
});

startingday.addEventListener('change', function(){
	html5Slider.noUiSlider.set([this.value, null]);
});

endday.addEventListener('change', function(){
	html5Slider.noUiSlider.set([null, this.value]);
});

var sliders = document.getElementsByClassName('sliders');

[].slice.call(sliders).forEach(function( slider, index ){

	noUiSlider.create(slider, {
		start: 1,
		connect: false,
		orientation: "vertical",
		tooltips: [true],
		direction: 'rtl',
		range: {
			'min': 0,
			'max': 1
		},
		pips: {
		mode: 'range',
		density: 3
	}
		});
	});

var app = new Array(16);
//24hours:1	,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16,17,18,19,20,21,22,23,24 light
app[0] = [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 15];
//24hours:1    ,2   ,3     ,4    ,5    ,6    ,7   , 8    , 9   , 10  ,11   ,12    ,13  ,14   ,15   ,16   ,17    ,18  ,19   ,20  ,21  ,22  ,23  ,24 sellphone
app[1] = [0.19, 0.19, 0.19, 0.19, 0.19, 0.19, 0.38, 0.38, 0.45, 0.45, 0.45, 0.45, 0.45, 0.45, 0.45, 0.38, 0.38, 0.38, 0.38,0.38, 0.7, 0.5, 0.19, 0.19, 15];
//24hours:1	,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16,17,18,19,20,21,22,23,24 E-bike
app[2] = [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.93, 0.96, 1, 0.5, 0, 0, 0, 100];
//24hours:1	,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16,17,18,19,20,21,22,23,24 workmusic
app[3] = [ 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 30];
//24hours:1	,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16,17,18,19,20,21,22,23,24 nightmusic
app[4] = [1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 30];
//24hours:1    ,2   ,3     ,4    ,5    ,6    ,7   , 8    , 9   , 10  ,11   ,12    ,13  ,14   ,15   ,16   ,17    ,18  ,19   ,20  ,21  ,22  ,23  ,24 fridge
app[5] = [0.31, 0.32, 0.35, 0.36, 0.35, 0.5, 0.42, 0.53, 0.52, 0.48, 0.59, 0.49, 0.6, 0.58, 0.57, 0.40, 0.36, 0.37, 0.45, 0.41, 0.37, 0.36, 0.40, 0.37, 150];
//24hours:			1	,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16,17,18,19,20,21,22,23,24 poolpump
app[6] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 300];
//24hours: 1    ,2   ,3     ,4    ,5    ,6    ,7   , 8    , 9   , 10  ,11   ,12    ,13  ,14   ,15   ,16   ,17    ,18  ,19   ,20  ,21  ,22  ,23  ,24 multimediaecke
app[7] = [0.26, 0.16, 0.18, 0.19, 0.18, 0.14, 0.14, 0.17, 0.17, 0.14, 0.14, 0.15, 0.19, 0.23, 0.68, 0.35, 0.14, 0.14, 0.63, 0.80, 0.79, 0.78, 0.67, 0.25, 100];
//24hours:1 ,2 ,3 ,4, 5.   6,  7, 8, 9, 10,11,12,13,  14,15,16,17,18,19,  20,21,22,23,24 wasserkocher
app[8] = [0, 0, 0, 0, 0, 0.13, 0, 0, 0, 0, 0, 0, 0, 0.13, 0, 0, 0,0, 0, 0.13, 0, 0, 0, 0, 1000];
//24hours:			1 ,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16, 17,18,19,20,21,22,23,24 s채ge
app[9] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.5, 0.3, 0, 0, 0, 0, 0, 0, 500];
//24hours:			 1 ,2 ,3 ,4, 5. 6, 7, 8, 	9, 		10 ,11  ,12  ,13   ,14    ,15   ,16   ,17,18,19,20,21,22,23,24 k체chenmaschine
app[10] = [0, 0, 0, 0, 0, 0, 0, 0.25, 0.25, 0.25, 0.5, 0.5, 0.5, 0.25, 0.25, 0.25, 0.25, 0, 0, 0, 0, 0, 0, 0, 40];
//24hours:			1  ,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16,17,18,19,20,21,22,23,24 ventilator
app[11] = [1, 1, 1, 1, 1, 1, 1, 1, 1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 30];
//24hours:			1  ,2 ,3 ,4, 5. 6, 7, 8, 9, 10,11,12,13,14,15,16,17,   18,   19,20,  21,22,23,24 E-bike
app[12] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.93, 0.96, 1, 0.5, 0, 0, 0];

var horizon =new Array(13);
horizon[0]=[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];	
horizon[1]=[0, 0, 30, 40, 45, 45, 45, 40, 45, 60, 60, 60, 60];

//needed for binding special profil or power to div if changed from default
function addapp(){
var appprofil = new Array(24);
for (var i=0; i<24; i++){
	var wert = document.getElementById(i);
	appprofil[i]=wert.noUiSlider.get();
}
var verbraucher = (document.getElementById('verbraucher').value*1);
var appname = $('select[id=profilauswahl]');
var appobject;
appobject="appid"+number+"";
var pickedapp = $('<div class="input-group mb-3" id="'+appobject+'" data-power="'+verbraucher+'" data-profil="'+appprofil+'"><input type="text" class="form-control" placeholder="'+appname.children(':selected').text()+' Leistung: '+verbraucher+'Watt" aria-label="app" aria-describedby="basic-addon2"><div class="input-group-append"><button class="btn btn-outline-secondary" type="button" onClick="editapp('+appobject+')">Edit Profil</button></div></div>');
$('#applist').append(pickedapp);
number++;
//console.log(document.getElementById('appid1').getAttribute("data-profil"));
}

function editapp(appobject){
$('#'+appobject.id+'').remove();
}
	
function refreshprofil(){
for (var i=0; i<24; i++){
	var regler = document.getElementById(i);
	var profilauswahl=document.getElementById('profilauswahl').value;
	profilersteller=app[profilauswahl][i];
	regler.noUiSlider.set(profilersteller);
}
var verbraucher = document.getElementById('verbraucher');
verbraucher.value = app[profilauswahl][24];
}

function horizonbeschriftung(){
var moduleazi = (document.getElementById('moduleazi').value*1);
var j = 0;
var beschriftung = 0;
if (moduleazi >=90 && moduleazi <=359){
j = (0-90);
}else{
		j = 270;
			}
for (var i=25; i<38; i++){
if ((moduleazi+j)<360){
	beschriftung = (moduleazi+j);
	document.getElementById(i).innerHTML = " "+beschriftung;
	j=j+15;
	}else{
	beschriftung = (moduleazi+j-360);
	document.getElementById(i).innerHTML = " "+beschriftung;
	j=j+15;
	}
	}
}
function refreshhorizon(){
	horizonbeschriftung();
	var j = 0;
for (var x=100; x<113; x++){
	var regulator = document.getElementById(x);
	horizontauswahl=document.getElementById('horizontauswahl').value;
	horizontersteller=horizon[horizontauswahl][j];
	regulator.noUiSlider.set(horizontersteller);
	j++
}
refresh();
}

//show the whperday after every changing
function refreshwhperday()
{
var timesum = 0;
var wattsum = 0;
for (var x = 1; x < number; x++){
var timesumapp = 0;
var appfinder = "appid"+x+"";
var watt = (document.getElementById(appfinder).getAttribute("data-power")*1);
var verbrauchsprofil = (document.getElementById(appfinder).getAttribute("data-profil"));
var vbrprofil = verbrauchsprofil.split(",");
for (var i=0; i<24; i++){
	timesumapp += (vbrprofil[i]*1);
}
timesum += timesumapp*watt
wattsum += watt;
}
var whperday = document.getElementById('whperday');
var verbraucher = document.getElementById('verbrauchtotal');
whperday.value = Math.round10(timesum);
verbraucher.value = wattsum;
}



function getsunblock(){
var moduleazi = (document.getElementById('moduleazi').value*1);
var sunblock = new Array(24);
var counter = (100);
var counter3 = (100);
var counter2 = (112);
for (var i=0; i<24; i++)
{
	if(moduleazi>=90 && moduleazi<270)
		{
		if(i<=((moduleazi/15)+6) && i>=((moduleazi/15)-6))
			{
			derwert = document.getElementById(counter);
			sunblock[i]= (derwert.noUiSlider.get()*1);
			if(counter<112){counter++;}
			}else{sunblock[i]= 0;}
		}else
			{
			if(moduleazi>=270){
							if(i<=((moduleazi/15)-18))
													{
													derwert = document.getElementById(counter2+(18-(moduleazi/15)));
													sunblock[i]= (derwert.noUiSlider.get()*1);
													counter2++;
													}else
													{
													if ( i >= ((moduleazi/15)-6)){
																					derwert = document.getElementById(counter);
																					sunblock[i]= (derwert.noUiSlider.get()*1);
																					counter++;
																				}else{sunblock[i]= 0;}
													}
							}else{
									if(i<=((moduleazi/15)+6)){
									derwert = document.getElementById(counter+(6-(moduleazi/15)));
									sunblock[i]= (derwert.noUiSlider.get()*1);
									counter++;
														}else{
																if(i>=(18+(moduleazi/15))){
																						derwert = document.getElementById(counter3);
																						sunblock[i]= (derwert.noUiSlider.get()*1);
																						counter3++;
																						}else{sunblock[i]=0;}
													}
							}
			}
}
return sunblock;
}
function gethorizonarrays(moduleazi, array){
var k = 0;
if (moduleazi >=90 && moduleazi <=269){
	k = ((moduleazi/15)-6);
	}else{
		if (moduleazi>269){
		k = ((moduleazi/15)-6);
			}else{k=(18+(moduleazi/15));}
		}
	var horizonarray = new Array (12);
for (j=0; j<13;j++){
	if ((k+j)>23){k=((-1)*j)}
	horizonarray[j]=(array[k+j]);
}
return horizonarray;
}
var schieber = document.getElementsByClassName('schieber');

[].slice.call(schieber).forEach(function( slider, index ){

	noUiSlider.create(slider, {
		start: 0,
		connect: false,
		orientation: "vertical",
		tooltips: [true],
		direction: 'rtl',
		range: {
			'min': 0,
			'max': 90
		},
		pips: {
		mode: 'range',
		density: 3
	}
		});
	});
//---------------------------------------------------------start-------------------------------------------------------------
function anfangarsch(){
$('#collapsecards').show({
  toggle: false
})
var latitude = document.getElementById('latitude').value;
var longitude = document.getElementById('longitude').value;
getGhi(latitude,longitude);
}

function getGhi(lat, lng)
{
    var request = {
				lat: lat,
				lng: lng
	};
    var json = JSON.stringify(request);
    $.ajax({
      type: "POST",
      dataType: "JSON",
      url: "https://base.energy/webservice/getGhi.php", //Relative or absolute path to response.php file
      data: json,
      success: function(realskyaverage) {
	  
		showtherest(realskyaverage, 216, 100, "2weak");
		//showtherest(realskyaverage, 450, 250, "good");
		//showtherest(realskyaverage, 720, 400, "outstanding");
		showbatterystatus(realskyaverage);
		showsolaryearly(realskyaverage);
		showhorizont(realskyaverage);
      }
    });
} // end getGhi

/*function download(data) {
console.log(data);

	/* this is here to download data
	var data = realskyarray2;
	var csvContent = "data:text/csv;charset=utf-8,";
	for (i=0;i<data.length;i++) {
		csvContent += data[i]+ "\n";
	
	}
	var encodedUri = encodeURI(csvContent);
	var link = document.createElement("a");
	link.setAttribute("href", encodedUri);
	link.setAttribute("download", "realskydaily_tilt"+tilt+"_azi"+moduleazi+"_latlong"+latitude+"_"+longitude+"_"+ratedpower+"kWp.csv");
	document.body.appendChild(link); // Required for FF

	link.click();*/
	
	/*var data = batteryarray;
	var csvContent = "data:text/csv;charset=utf-8,";
	//csvContent += ""
	data.forEach(function(infoArray, index){

	   dataString = infoArray.join(";");
	   csvContent += index < data.length ? dataString+ "\n" : dataString;

	});

	var encodedUri = encodeURI(csvContent);
	var link = document.createElement("a");
	link.setAttribute("href", encodedUri);
	//link.setAttribute("download", "realskyhourly_tilt"+tilt+"_azi"+moduleazi+"_latlong"+latitude+"_"+longitude+"_"+ratedpower+"kWp.csv");
	link.setAttribute("download", "batteryarray_verbraucher"+verbraucher+"_apnumber"+appnumber+"_batterysize"+batterysize+"_"+ratedpower+"kWp.csv");
	document.body.appendChild(link); // Required for FF

	link.click();
}*/
//Converts from radians to degrees. used in drawhorizont
Math.degrees = function(radians) {
  return radians * 180 / Math.PI;
}

function showbatterystatus(realskyaverage){
var latitude = document.getElementById('latitude').value;
var tilt = document.getElementById('tilt').value;
var moduleazi = document.getElementById('moduleazi').value;
var anfang = (document.getElementById('anfang').value*1);
var ende = (document.getElementById('ende').value*1);
var verbraucher = document.getElementById('verbrauchtotal').value;
var ratedpower = document.getElementById('ratedpower').value;
var whpercycle = document.getElementById('whperday').value;
var batterysize = document.getElementById('batterysize').value;

var appprofil = new Array(24);
for (var i=0; i<24; i++){
appprofil[i] = 0;
}
for (var i=0; i<24; i++){
for (var x = 1; x < number; x++){
var appfinder = "appid"+x+"";
try{
var verbrauchsprofil = (document.getElementById(appfinder).getAttribute("data-profil"));
var watt = (document.getElementById(appfinder).getAttribute("data-power")*1)
}catch {
var verbrauchsprofil = "0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.93,0.96,1.00,0.50,0.00,0.00,0.00";
var watt = 0;
}
var vbrprofil = verbrauchsprofil.split(",");
var vbrprofilint = (vbrprofil[i]*1);
	appprofil[i] += (watt*vbrprofilint);
	//console.log(typeof (watt*(vbrprofil[i]*1)));
}
}
var sunblock = getsunblock();
//console.log(sunblock);

//var realsky = RealskyValue(latitude, realskyaverage, tilt, moduleazi, ratedpower, sunblock);

var battery = CycleCounter(latitude, tilt, moduleazi, realskyaverage, ratedpower, batterysize, whpercycle, appprofil, anfang, ende, sunblock, 3);
var batteryarray = battery[3];
var realskyarray = battery[4];
drawbatterystatus(batteryarray, realskyarray);
}

function showsolaryearly(realskyaverage) {
var latitude = document.getElementById('latitude').value;
var tilt = document.getElementById('tilt').value;
var moduleazi = document.getElementById('moduleazi').value;
var ratedpower = document.getElementById('ratedpower').value;

var sunblock = getsunblock();
var realskyarray = RealskyValue(latitude, realskyaverage, tilt, moduleazi, 1000, sunblock); //1000 Wp bedeutet eine Fl채che von 1m짼 bei STC
var realsky = realskyarray[2];
var clearskyarray = ClearskyValue(latitude, tilt, moduleazi);
var clearsky = clearskyarray[4];
//console.log(realsky);
drawrealskyyearly(realsky, clearsky);
}

function showhorizont(realskyaverage) {
var latitude = document.getElementById('latitude').value;
var tilt = document.getElementById('tilt').value;
var moduleazi = document.getElementById('moduleazi').value;
var ratedpower = document.getElementById('ratedpower').value;
var sunblock = getsunblock();

var clearskyvalue = ClearskyValue(latitude, realskyaverage, tilt, moduleazi, ratedpower, sunblock);
var sunalti = clearskyvalue[2];
drawhorizont(sunalti, sunblock);
}

function showtherest(realskyaverage, batterysize, ratedpower, target){
var latitude = document.getElementById('latitude').value;
var tilt = document.getElementById('tilt').value;
var moduleazi = document.getElementById('moduleazi').value;
var anfang = (document.getElementById('anfang').value*1);
var ende = (document.getElementById('ende').value*1);
var whpercycle = document.getElementById('whperday').value;
var sunblock = getsunblock();
var appprofil = new Array(24);
for (var i=0; i<24; i++){
appprofil[i] = 0;
}
for (var i=0; i<24; i++){
for (var x = 1; x < number; x++){
var appfinder = "appid"+x+"";
try{
var verbrauchsprofil = (document.getElementById(appfinder).getAttribute("data-profil"));
var watt = (document.getElementById(appfinder).getAttribute("data-power")*1)
}catch {
var verbrauchsprofil = "0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.93,0.96,1.00,0.50,0.00,0.00,0.00";
var watt = 0;
}
var vbrprofil = verbrauchsprofil.split(",");
	appprofil[i] += (watt*vbrprofil[i]);
}
}

var cyclecounter = CycleCounter(latitude, tilt, moduleazi, realskyaverage, ratedpower, batterysize, whpercycle, appprofil, anfang, ende, sunblock);
var solarautarkie = cyclecounter[2];
if (solarautarkie < 0.7){
	ratedpower += 100;
	if(ratedpower > 300){
				batterysize += 264;
				showtherest(realskyaverage, batterysize, ratedpower, target);
				}else{
						showtherest(realskyaverage, batterysize, ratedpower, target);
						}
				}else{

var zombieapo=getzombiemode(batterysize, appprofil);
//console.log("zombieapocalypsemode " +zombieapo);
var chargetime=getbatterychargetime(latitude, tilt, moduleazi, realskyaverage, ratedpower, batterysize, sunblock);
//console.log("chargetime is " + chargetime);
var peakcycle = getpeakcycle(whpercycle, latitude, realskyaverage, tilt, moduleazi, ratedpower, sunblock);
//console.log("peakcycle "+peakcycle);

if(solarautarkie > 0.85){
	var solarautarkieline = "<br> <span style='color:green;font-weight:bold'>solarautarkie = "+Math.round(solarautarkie*100)+"%</span>";
		}else if(solarautarkie<0.85 && solarautarkie>0.60){
			 solarautarkieline = "<br> <span style='color:orange;font-weight:bold'>solarautarkie = "+Math.round(solarautarkie*100)+"%</span>";
				}else{
					solarautarkieline = "<br> <span style='color:red;font-weight:bold'>solarautarkie = "+Math.round(solarautarkie*100)+"%</span>";
				}
switch(target){
case "2weak":
var list = "basiclist";
var listmod= "basicmod";
var listbat= "basicbat";
break;
case "good":
var list = "prolist";
var listmod= "promod";
var listbat= "probat";
break;
case "outstanding":
var list = "ultimatelist";
var listmod= "ultimod";
var listbat= "ultibat";
break;
}
document.getElementById(target).innerHTML = "zombieapocalypsemode (h) " + zombieapo + "<br> chargetime needed (h) " + chargetime + solarautarkieline;
document.getElementById(list).innerHTML = "<li class='list-group-item'>batterysize: <p id='"+listbat+"'>"+batterysize+"</p></li><li class='list-group-item'>ratedpower: <p id='"+listmod+"'>"+ratedpower+"</p></li>";
if(target== "outstanding"){return;}
if(target == "good"){
target = "outstanding";
}else{target = "good"}
showtherest(realskyaverage, batterysize, (ratedpower+100), target)
}
}

function drawbatterystatus(batteryarray, realskyarray){
	var anfang = (document.getElementById('anfang').value*1);
	var batterysize = (document.getElementById('batterysize').value*1);
	var pvleistung = (document.getElementById('ratedpower').value*1);
	var realsky3tage = new Array;
	for (var j=anfang; j<=(anfang+2);j++){
	var i=0;
		while(i<24){
		realsky3tage.push(realskyarray[j][i]);
		i++
		}
	}
	var batteryarray3tage = new Array;
	for (var j=anfang; j<=(anfang+2);j++){
	var i=0;
		while(i<24){
		batteryarray3tage.push(((batteryarray[j][i]/batterysize)*100));
		i++
		}
	}
	//console.log(batteryarray3tage);
	var xbeschriftung72stunden = new Array (72);
	var i = 0;
	for (var j=0; j<=(72);j++){
	if (i==23){
	i = 0
	}
	xbeschriftung72stunden[j]=i;
	i++;
	}
	var Dataset = {
				labels: xbeschriftung72stunden,
				datasets: [{
					label: 'Batterystatus',
					yAxisID: 'A',
					fill: false,
					borderColor: "rgba(75,191,192,1)",
					data: batteryarray3tage,
					borderWidth: 1
				},
				{
					label: 'PV',
					yAxisID: 'B',
					borderColor: "rgba(255, 0, 0, 1)",
					data: realsky3tage,
					borderWidth: 0.5
				}]
			}
	var chartoptions =  {
				responsive: false,
				legend: {
					display: true
				},
				scales: {
				xAxes: 
					[{
						ticks: {
							autoSkip: true,
							maxTicksLimit: 12
						}
					}],
					yAxes:  [{
							id: 'A',
							type: 'linear',
							position: 'left',
							ticks: {
										min:0,
										max:100,
										stepSize: 10
									},
							gridLines: {
								color: 'rgba(75,191,192,0.5)' // makes grid lines from y axis red
										},
							scaleLabel: {
										display: true,
										labelString: 'Batterystatus in %'
									  }
						  },
						  {
							id: 'B',
							type: 'linear',
							position: 'right',
							ticks: {	
										min:0,
										stepSize: (Math.max(...realsky3tage)/10)
									},
							gridLines: {
								color: 'rgba(255, 0, 0, 0.5)' // makes grid lines from y axis red
										},
										scaleLabel: {
													display: true,
													labelString: 'PV-Ertrag in Watt'
												  }
							}]
				}/*,
				chartArea: {
					backgroundColor: 'rgba(251, 85, 0, 0.4)'
				}*/
			}
	
	var config={
			type: 'line',
			data: Dataset,
			options: chartoptions
		};

	var ctx = document.getElementById("batterystatuschart").getContext('2d');
	if(!myChart1){
		myChart1 = new Chart(ctx, config);
		}else{
		myChart1.config.data = Dataset;
		myChart1.options = chartoptions;
		myChart1.update();
		}
}
function drawhorizont(sunalti, sunblock){
var moduleazi = (document.getElementById('moduleazi').value*1);
for (j=0; j<24;j++){
	sunalti[81][j] = Math.degrees(sunalti[81][j]);
	sunalti[180][j] = Math.degrees(sunalti[180][j]);
	sunalti[360][j] = Math.degrees(sunalti[360][j]);
}
var horizon = gethorizonarrays(moduleazi, sunblock);
var m채rzfrische = gethorizonarrays(moduleazi, sunalti[81]);
var sommerday = gethorizonarrays(moduleazi, sunalti[180]);
var Winterzeit = gethorizonarrays(moduleazi, sunalti[360]);
//console.log(horizon, m채rzfrische, sommerday, Winterzeit);

var j = 0;
if (moduleazi >=90 && moduleazi <=359){
j = (0-90);
}else{
		j = 270;
			}
var xbeschriftunghorizon = new Array (13);
for (var i=0; i<(13);i++){
if ((moduleazi+j)<360){
	xbeschriftunghorizon[i] = (moduleazi+j);
	j=j+15;
	}else{
	xbeschriftunghorizon[i] = (moduleazi+j-360);
	j=j+15;
	}
}
var Dataset= {
			labels: xbeschriftunghorizon,
			datasets: [{
				label: 'Your Horizon',
				//yAxisID: 'A',
				fill: false,
				borderColor: "rgba(75,191,192,1)",
				data: horizon,
				borderWidth: 0.5
			},
			{
				label: 'M채rzfrische',
				//yAxisID: 'B',
				fill: false,
				borderColor: "rgba(255, 255, 0, 1)",
				data: m채rzfrische,
				borderWidth: 0.5
			},
			{
				label: 'sommerday',
				//yAxisID: 'B',
				fill: false,
				borderColor: "rgba(0, 0, 0, 1)",
				data: sommerday,
				borderWidth: 0.5
			},
			{
				label: 'Winterzeit',
				//yAxisID: 'B',
				fill: false,
				borderColor: "rgba(255, 0, 0, 1)",
				data: Winterzeit,
				borderWidth: 0.5
			}]
		};
	var chartoptions = {
			responsive: false,
			legend: {
				display: true
			},
			scales: {
			xAxes: 
				[{
					ticks: {
						//autoSkip: true,
						//maxTicksLimit: 100
					}
				}],
			yAxes:  [{
						type: 'linear',
						position: 'left',
						ticks: {
									min:0,
									max: 90,
									stepSize: 10
								},
								scaleLabel: {
											display: true,
											labelString: 'Winkel von Modul aus in Grad'
										  }
					  }]
			}
		}
			var config={
			type: 'line',
			data: Dataset,
			options: chartoptions
		};
		
var ctx = document.getElementById("horizon").getContext('2d');
	if(!myChart2){
		myChart2 = new Chart(ctx, config);
		}else{
		myChart2.config.data = Dataset;
		myChart2.options = chartoptions;
		myChart2.update();
		}
}

function drawrealskyyearly(realskyarray, clearskyarray) {
var pvleistung = (document.getElementById('ratedpower').value*1);
var realsky365tage = new Array;
for (var j=1; j<=365;j++){
	realsky365tage.push(realskyarray[j]);
}
var clearsky365tage = new Array;
for (var j=1; j<=365;j++){
	clearsky365tage.push(clearskyarray[j]);
}
//console.log(batteryarray3tage);
var xbeschriftung365tage = new Array (365);
for (var j=0; j<=(365);j++){
xbeschriftung365tage[j]=j;
}

var Dataset = {
			labels: xbeschriftung365tage,
			datasets: [{
				label: 'RealskyValue',
				//yAxisID: 'A',
				fill: false,
				borderColor: "rgba(75,191,192,1)",
				data: realsky365tage,
				borderWidth: 0.5
			},
			{
				label: 'ClearskyValue',
				//yAxisID: 'B',
				fill: false,
				borderColor: "rgba(255, 0, 0, 1)",
				data: clearsky365tage,
				borderWidth: 0.5
			}]
		};
var chartoptions = {
			responsive: false,
			legend: {
				display: true
			},
			scales: {
			xAxes: 
				[{
					ticks: {
						autoSkip: true,
						maxTicksLimit: 100
					}
				}],
			yAxes:  [{
						type: 'linear',
						position: 'left',
						ticks: {
									min:0,
									stepSize: (Math.round(Math.max(...clearsky365tage)/10))
								},
								scaleLabel: {
											display: true,
											labelString: 'Einstrahlung in Watt/m짼'
										  }
					  }]
			}
		}
		var config={
			type: 'line',
			data: Dataset,
			options: chartoptions
		};

var ctx = document.getElementById("yearlysolar").getContext('2d');
		if(!myChart3){
		myChart3 = new Chart(ctx, config);
		}else{
		myChart3.config.data = Dataset;
		myChart3.options = chartoptions;
		myChart3.update();
		}
}
//needed for drawing night
		Chart.pluginService.register({
			beforeDraw: function (chart, easing) {
				if (chart.config.options.chartArea && chart.config.options.chartArea.backgroundColor) {
					var helpers = Chart.helpers;
					var ctx = chart.chart.ctx;
					var chartArea = chart.chartArea;

          var columnCount = chart.data.datasets[0].data.length;
          var width = chartArea.right - chartArea.left;
          var height = chartArea.bottom - chartArea.top

					var columnWidth = width*(0.66);
					ctx.save();
					ctx.fillStyle = chart.config.options.chartArea.backgroundColor;
          var startPoint = chartArea.left
          while (startPoint < chartArea.right) {
          	ctx.fillRect(startPoint, chartArea.top, columnWidth, height);
            startPoint += columnWidth * 2;
          }
					ctx.restore();
				}
			}
		});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>